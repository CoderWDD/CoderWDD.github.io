---
category:
  - Database
index : 7
title : 第七章：数据库事务与故障恢复
---
# 数据库操作概述

## 事务

- 数据库操作的组织模式：事务
  - 一个数据库操作序列；
  - 一个不可分割的工作单元；
  - 恢复和并发控制的基本单元。

- 定义语法：

  - 提交：

    ```sql
    BEGIN TRANSACTION
    SQL 语句1
    SQL 语句2 
    ……
    COMMIT
    ```

  - 回滚：

    ```sql
    BEGIN TRANSACTION
    SQL 语句1
    SQL 语句2
    ……
    ROLLBACK
    ```

- 事务的ACID特性：
  - 原子性
  - 一致性
  - 隔离性
  - 持久性

## 问题引入

![image-20220524215427332](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524215427332.png)

![image-20220524215448605](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524215448605.png)

# 数据库故障类型

- 数据库故障分类：
  - 事务内部的故障
  - 系统故障
  - 介质故障
  - 计算机病毒

## 事务内部的故障

- 特点：

  - 非预期的，不能由应用程序处理。

  - 发生事务故障时，事务中的操作一部分已经发生，一部分还没有开始，因此需要对发生的操作进行撤销（**UNDO**）。

## 系统故障

- 含义：也称为软故障，指造成系统停止运转的任何事件

- 特点：
  - 系统要重新启动； 
  - 整个系统的正常运行突然被破坏；
  - 所有正在运行的事务都非正常终止；
  - 没有破坏数据库；
  - 内存中数据库缓冲区的信息全部丢失。

- 可能导致的现象：
  - 事务未执行完成：
    - 恢复策略：**强行撤销**（UNDO）所有未完成事务；
  - 事务已执行完成（提交），但缓冲区中的数据尚未完全写回到磁盘上
    - 恢复策略：重做（REDO）所有已提交的事务。

## 介质故障

- 含义：称为硬故障，指外存故障

- 特点：
  - 磁盘损坏；
  - 磁头碰撞；
  - 操作系统的某种潜在错误；
  - 瞬时强磁场干扰。

- 恢复策略：装入数据库发生介质故障前某个时刻的数据副本，重做自此时开始的所有成功事务，将这些事务已提交的结果重新写入数据库

# 数据库恢复技术

- 数据库恢复：把数据库从错误状态恢复到某一已知的正确状态（亦称为一致状态或完整状态）。

- 恢复机制涉及的关键问题
  - 如何建立冗余数据；
  - 如何利用这些冗余数据实施数据库恢复。
- 建立冗余数据的基本技术
  - 数据转储（数据备份）
  - 登录日志文件

## 数据转储

- 数据转储：指DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程，备用的数据称为后备副本或后援副本。

## 登录日志

- 日志文件：记录事务对数据库进行更新的操作（包括操作类型、操作时间、操作用户、操作结果等）的文件

- 日志文件的格式
  - 以记录为单位的日志文件：每条日志记录保存如下信息
    - 各个事务的开始标记(BEGIN TRANSACTION)
    - 各个事务的结束标记(COMMIT或ROLLBACK)
    - 各个事务的所有更新操作
  - 以数据块为单位的日志文件：每条日志记录保存如下信息
    - 事务标识（标明是那个事务）
    - 被更新的数据块

- 日志文件在数据库故障恢复中的角色
  - 帮助DBMS自动进行事务故障恢复；
  - 帮助DBMS进行系统故障恢复；
  - 协助后备副本进行介质故障恢复。

- 登记日志文件基本原则
  - 登记的次序严格按并行事务执行的时间次序；
  - **`必须先写日志文件，后写数据库`**
    - 写日志文件操作：把当前更新操作的详细信息记录到日志文件中；
    - 写数据库操作：把对数据的修改结果写到数据库中。

## 事务故障恢复

![image-20220524213509647](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524213509647.png)

- 事务故障
  - 事务在运行至正常终止点前被终止；
  - 表现现象：事务的一部分操作已经发生，且可能把结果写入数据库；一部分操作还没有发生，且由于发生故障，无法继续执行。

- 恢复方法：由数据库恢复子系统利用日志文件撤销（UNDO）此事务已对数据库进行的修改。
- 特点：由DBMS自动完成，对用户透明

- 事务故障恢复步骤

  - 反向扫描文件日志（即从最后向前扫描日志文件），查找该事务的更新操作；

  - 对该事务的更新操作执行逆操作，即将日志记录中“更新前的值” 写入数据库。

    - 插入操作： “更新前的值”为空，需要做删除操作；

    - 删除操作：“更新后的值”为空，需要做插入操作；
      - 修改操作：用修改前值代替修改后值。

  - 继续反向扫描日志文件，查找该事务的其它更新操作，并做同样处理；如此处理下去，直至读到此事务的开始标记，事务故障恢复完成。

## 系统故障恢复

![image-20220524213530199](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524213530199.png)

- 系统故障造成数据库不一致状态的原因：
  - 未完成事务对数据库的更新已写入数据库；
  - 已提交事务对数据库的更新还留在缓冲区没来得及写入数据库。
- 恢复方法：
  - Undo 故障发生时未完成的事务；
  - Redo 已完成的事务。
- 系统故障的恢复由系统在重新启动时自动完成，无需用户干预。

### 恢复细节

- 正向扫描日志文件（即从头扫描日志文件），建立**重做队列和撤销队列**：

  - 重做(REDO) 队列: 在故障发生前已经提交的事务列表，这些事务在日志文件中既有BEGIN TRANSACTION记录，也有COMMIT记录；

  - 撤销 (UNDO)队列：故障发生时尚未完成的事务列表，这些事务在日志文件中只有BEGIN TRANSACTION记录，无对应的COMMIT记录。

- 对撤销队列中的事务进行撤销(UNDO)处理：
  - 反向扫描日志文件，对每个UNDO事务中的更新操作执行逆操作，即将日志记录中”更新前的值”写入数据库。 
- 对重做队列中的事务进行重做(REDO)处理：
  - 正向扫描日志文件，重新执行每个REDO事务中登记的操作，即将日志记录中“更新后的值”写入数据库。

## 介质故障恢复

![image-20220524213758151](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524213758151.png)

- 介质故障恢复步骤：
  - 装入最新的后备数据库副本，使数据库恢复到最近一次转储时的一致性状态。
    - 对于静态转储的数据库副本，装入后数据库即处于一致性状态；对于动态转储的数据库副本，还须同时装入转储时刻的日志文件副本，利用恢复系统故障的方法（即REDO+UNDO），才能将数据库恢复到一致性状态。
  - 装入有关的日志文件副本，重做已完成的事务。
    - 首先扫描日志文件，找出故障发生时已提交的事务的标识，将其记入重做队列；
    - 然后正向扫描日志文件，对重做队列中的所有事务进行重做处理，即将日志记录中“更新后的值”写入数据库。

## 检查点

- 检查点（checkpoint）：日志文件的附属品，其定期或按照预定规则对系统中当前事务的状态进行记录，**每一个记录称为一个检查点。**

- 建立检查点：
  - 在日志文件中增加检查点记录；
  - 增加一个重新开始文件；
  - 恢复子系统在登录日志文件期间动态地建立检查点记录，以及重新开始文件与检查点记录的对应关系。

- 检查点记录的内容

  - 建立检查点时刻所有正在执行的事务清单；
  - 这些事务最近一个日志记录的地址。

- 重新开始文件的内容

  - 记录各个检查点记录在日志文件中的地址。

  ![](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524214804947.png)

- 日志文件的动态维护
  - 周期性地执行如下操作：建立检查点，保存数据库状态。
    - 将当前日志缓冲区中的所有日志记录写入磁盘的日志文件上；
    - 在日志文件中写入一个检查点记录；
    - 将当前数据缓冲区的所有数据记录写入磁盘的数据库中；
    - 把检查点记录在日志文件中的地址写入一个重新开始文件；

- 好处：
  - 出现系统故障时，最新的检查点之前的所有已完成事务可确保将操作结果写入数据库，无需处理；只需要关注建立检查点时正在执行的事务和检查点之后开始的事务
  - 检查点提高了数据的恢复效率

- 恢复子系统可以定期或不定期地建立检查点，保存数据库状态 
  - 定期
    - 按照预定的一个时间间隔，如每隔一小时建立一个检查点； 
  - 不定期
    - 按照某种规则，如日志文件已写满一半建立一个检查点。

### 基于检查点的数据恢复步骤
1. 从重新开始文件中找到最后（新）一个检查点记录在日志文件中的地址，由该地址在日志文件中找到最后一个检查点记录；
2. 由该检查点记录得到检查点建立时刻所有正在执行的事务清单，设为ACTIVE-LIST
3. 建立两个事务队列
   - UNDO-LIST 
   - REDO-LIST 
4. 把ACTIVE-LIST暂时放入UNDO-LIST队列，REDO队列暂为空。
5. 从检查点开始正向扫描日志文件，直到日志文件结束
   - 如有新开始的事务Ti，把Ti暂时放入UNDO-LIST队列
   - 如有提交的事务Tj，把Tj从UNDO-LIST队列移到REDO-LIST队列
6. 对UNDO-LIST中的每个事务执行UNDO操作，对REDO-LIST中的每个事务执行REDO操作。

# 数据库镜像

- 作用：保证镜像数据与主数据库的一致性

- 机制：

  - 每当主数据库更新时，DBMS自动把更新后的数据复制过去。
  - DBMS支持把整个数据库或其中的关键数据复制到另一个磁盘上；

  ![image-20220524214955960](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524214955960.png)

## 数据库镜像与介质故障

- 作用：
  - 可由镜像磁盘继续提供服务； 
  - DBMS自动利用镜像磁盘数据进行主数据库的恢复，无需关闭系统和重装数据库副本。

![image-20220524215041195](https://raw.githubusercontent.com/CoderWDD/myImages/main/blog_images/image-20220524215041195.png)

- 注意：频繁地复制数据会降低系统运行效率，因此，实际应用中，**往往只对关键数据和日志文件镜像**，而不是对整个数据库进行镜像。

# 总结

- 如果数据库**只**包含成功事务提交的结果，则称数据库处于**一致性**状态。
- 保证数据一致性是对数据库的**最基本**的要求。
- 事务是数据库的逻辑工作单元
  - DBMS保证系统中一切事务的原子性、一致性、隔离性和持续性。
- DBMS提供事务故障、系统故障和介质故障的恢复功能；
- 恢复中最经常使用的技术：**数据库转储和登记日志文件**；
- 恢复的基本原理：利用存储在后备副本、日志文件和数据库镜像中的冗余数据来重建数据库。

- 提高恢复效率的技术：
  - 检查点技术
    - 可以提高系统故障的恢复效率；
    - 可以在一定程度上提高利用动态转储备份进行介质故障恢复的效率。
  - 镜像技术
    - 镜像技术可以改善介质故障的恢复效率。
